<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>発音練習アプリ</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* 録音中アニメーション */
  .pulse {
    display: inline-block;
    width: 12px;
    height: 12px;
    margin: 0 2px;
    background: #34D399;
    border-radius: 50%;
    animation: pulse 1s infinite alternate;
  }
  .pulse:nth-child(2) { animation-delay: 0.2s; }
  .pulse:nth-child(3) { animation-delay: 0.4s; }
  @keyframes pulse {
    0% { transform: scale(1); opacity: 0.6; }
    100% { transform: scale(1.5); opacity: 1; }
  }
</style>
</head>
<body class="bg-gray-50 flex flex-col items-center justify-center min-h-screen font-sans">

<div class="w-full max-w-xl bg-white shadow-lg rounded-xl p-6">
  <h1 class="text-3xl font-bold text-center mb-6">発音練習アプリ</h1>

  <!-- 例文表示 -->
  <div id="sentence" class="text-2xl font-semibold text-center mb-6 p-4 bg-gray-100 rounded-lg"></div>

  <!-- ボタン群 -->
  <div class="flex justify-center gap-4 mb-6">
    <button id="newSentence" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-6 py-3 rounded-lg transition">新しい例文</button>
    <button id="start" class="bg-green-500 hover:bg-green-600 text-white font-bold px-6 py-3 rounded-lg transition">録音開始</button>
    <button id="stop" class="bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-3 rounded-lg transition">録音停止</button>
  </div>

  <!-- 認識結果表示 -->
  <div class="bg-yellow-100 p-4 rounded-lg mb-4">
    <h2 class="font-semibold mb-2">認識結果</h2>
    <div id="recognizedText" class="text-lg text-gray-800 min-h-[2rem] flex items-center"></div>
  </div>

  <!-- スコア表示 -->
  <div class="bg-green-100 p-4 rounded-lg">
    <h2 class="font-semibold mb-2">発音スコア</h2>
    <div id="scoreBar" class="h-6 bg-gray-300 rounded-full overflow-hidden">
      <div id="scoreFill" class="h-6 w-0 bg-green-500 text-white text-center font-bold transition-all"></div>
    </div>
    <div id="scoreText" class="text-center mt-2 font-bold text-gray-900"></div>
  </div>
</div>

<script>
const sentenceList = [
  "I like apples.",
  "She is reading a book.",
  "He goes to school every day.",
  "Today is a sunny day.",
  "Can you help me?",
  "We are learning English.",
  "The cat is sleeping on the sofa.",
  "I enjoy playing soccer."
];

let recognition;
let recognizing = false;

function getRandomSentence() {
  return sentenceList[Math.floor(Math.random() * sentenceList.length)];
}

document.getElementById("sentence").innerText = getRandomSentence();

document.getElementById("newSentence").onclick = () => {
  document.getElementById("sentence").innerText = getRandomSentence();
  document.getElementById("recognizedText").innerHTML = "";
  updateScore(0);
};

// 録音中アニメーション表示
function showRecordingAnimation() {
  const container = document.getElementById("recognizedText");
  container.innerHTML = '';
  for(let i=0; i<3; i++){
    const dot = document.createElement('span');
    dot.className = 'pulse';
    container.appendChild(dot);
  }
}

// スコアバー更新
function updateScore(score) {
  const fill = document.getElementById("scoreFill");
  fill.style.width = `${score}%`;
  if(score <= 50){
    fill.style.backgroundColor = '#F87171'; // 赤
  } else if(score <= 80){
    fill.style.backgroundColor = '#FBBF24'; // 黄
  } else {
    fill.style.backgroundColor = '#34D399'; // 緑
  }
  document.getElementById("scoreText").innerText = `${score} 点`;
}

// Web Speech API の初期化
if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.continuous = false;

  recognition.onstart = () => {
    recognizing = true;
    showRecordingAnimation();
    updateScore(0);
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById("recognizedText").innerText = transcript;

    const correctText = document.getElementById("sentence").innerText;
    const similarity = stringSimilarity(correctText, transcript);
    const score = Math.round(similarity * 100);
    updateScore(score);
  };

  recognition.onerror = (event) => {
    document.getElementById("recognizedText").innerText = `認識エラー: ${event.error}`;
    updateScore(0);
  };

  recognition.onend = () => {
    recognizing = false;
  };
} else {
  alert("Web Speech API に対応していないブラウザです。Chrome または Edge を使用してください。");
}

document.getElementById("start").onclick = () => {
  if (!recognizing) recognition.start();
};

document.getElementById("stop").onclick = () => {
  if (recognizing) recognition.stop();
};

// 文字列類似度（レーベンシュタイン距離）
function stringSimilarity(str1, str2) {
  str1 = str1.toLowerCase().replace(/[^\w\s]/gi,'');
  str2 = str2.toLowerCase().replace(/[^\w\s]/gi,'');
  const longer = str1.length > str2.length ? str1 : str2;
  const shorter = str1.length > str2.length ? str2 : str1;
  const longerLength = longer.length;
  if (longerLength === 0) return 1.0;
  const editDist = levenshtein(longer, shorter);
  return (longerLength - editDist) / longerLength;
}

function levenshtein(a, b) {
  const matrix = [];
  for (let i = 0; i <= b.length; i++) matrix[i] = [i];
  for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
  for (let i = 1; i <= b.length; i++) {
    matrix[i] = [];
    matrix[i][0] = i;
  }
  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      matrix[i][j] = (b.charAt(i-1) === a.charAt(j-1)) ?
        matrix[i-1][j-1] :
        Math.min(matrix[i-1][j-1]+1, matrix[i][j-1]+1, matrix[i-1][j]+1);
    }
  }
  return matrix[b.length][a.length];
}
</script>

</body>
</html>

